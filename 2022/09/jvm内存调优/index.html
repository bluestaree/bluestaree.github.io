<!DOCTYPE html>
<html lang="zh">
  <head>
    <title>
        JVM内存调优 - AzkeepToo个人博客
      </title>
        <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="renderer" content="webkit">
    <meta http-equiv="Cache-Control" content="no-transform" />
    <meta http-equiv="Cache-Control" content="no-siteapp" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    
    <meta name="theme-color" content="#000000" />
    
    <meta http-equiv="window-target" content="_top" />
    
    
    <meta name="description" content="最近发现服务器在部署一段时间后会自动重启，初步排查为内存原因，肯能存在内存泄漏，需进一步排查。这里记录一下相关学习记录 JVM内存调优 1、JV" />
    <meta name="generator" content="Hugo 0.69.2 with theme pure" />
    <title>JVM内存调优 - AzkeepToo个人博客</title>
    
    
    <link rel="stylesheet" href="https://bluestaree.github.io/css/style.min.06fbaa72257ed699120e00925d277105b1a5264eafe68569fc288d3492f0d036.css">
    
    <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/9.15.10/styles/github.min.css" async>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css" async>
    <meta property="og:title" content="JVM内存调优" />
<meta property="og:description" content="最近发现服务器在部署一段时间后会自动重启，初步排查为内存原因，肯能存在内存泄漏，需进一步排查。这里记录一下相关学习记录 JVM内存调优 1、JV" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://bluestaree.github.io/2022/09/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98/" />
<meta property="article:published_time" content="2022-09-12T00:00:00+00:00" />
<meta property="article:modified_time" content="2022-09-12T00:00:00+00:00" />
<meta itemprop="name" content="JVM内存调优">
<meta itemprop="description" content="最近发现服务器在部署一段时间后会自动重启，初步排查为内存原因，肯能存在内存泄漏，需进一步排查。这里记录一下相关学习记录 JVM内存调优 1、JV">
<meta itemprop="datePublished" content="2022-09-12T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2022-09-12T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="10848">



<meta itemprop="keywords" content="jvm," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="JVM内存调优"/>
<meta name="twitter:description" content="最近发现服务器在部署一段时间后会自动重启，初步排查为内存原因，肯能存在内存泄漏，需进一步排查。这里记录一下相关学习记录 JVM内存调优 1、JV"/>

    <!--[if lte IE 9]>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
      <![endif]-->

    <!--[if lt IE 9]>
        <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
      <![endif]-->
  </head>

  
  

  <body class="main-center theme-black" itemscope itemtype="http://schema.org/WebPage"><header class="header" itemscope itemtype="http://schema.org/WPHeader">
    <div class="slimContent">
      <div class="navbar-header">
        <div class="profile-block text-center">
          <a id="avatar" href="https://github.com/bluestaree" target="_blank">
            <img class="img-circle img-rotate" src="https://bluestaree.github.io/avatar.jpg" width="200" height="200">
          </a>
          <h2 id="name" class="hidden-xs hidden-sm">bluestaree</h2>
          <h3 id="title" class="hidden-xs hidden-sm hidden-md">某超自然事件研究学徒</h3>
          <small id="location" class="text-muted hidden-xs hidden-sm"><i class="icon icon-map-marker"></i>龙岩, 福建</small>
        </div><div class="search" id="search-form-wrap">
    <form class="search-form sidebar-form">
        <div class="input-group">
            <input type="text" class="search-form-input form-control" placeholder="搜索" />
            <span class="input-group-btn">
                <button type="submit" class="search-form-submit btn btn-flat" onclick="return false;"><i
                        class="icon icon-search"></i></button>
            </span>
        </div>
        <div class="ins-search">
            <div class="ins-search-mask"></div>
            <div class="ins-search-container">
                <div class="ins-input-wrapper">
                    <input type="text" class="ins-search-input" placeholder="想要查找什么..."
                        x-webkit-speech />
                    <button type="button" class="close ins-close ins-selectable" data-dismiss="modal"
                        aria-label="Close"><span aria-hidden="true">×</span></button>
                </div>
                <div class="ins-section-wrapper">
                    <div class="ins-section-container"></div>
                </div>
            </div>
        </div>
    </form>
</div>
        <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#main-navbar" aria-controls="main-navbar" aria-expanded="false">
          <span class="sr-only">Toggle navigation</span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
      </div>
      <nav id="main-navbar" class="collapse navbar-collapse" itemscope itemtype="http://schema.org/SiteNavigationElement" role="navigation">
        <ul class="nav navbar-nav main-nav">
            <li class="menu-item menu-item-home">
                <a href="/">
                    <i class="icon icon-home-fill"></i>
                  <span class="menu-title">主页</span>
                </a>
            </li>
            <li class="menu-item menu-item-categories">
                <a href="/categories/">
                    <i class="icon icon-folder"></i>
                  <span class="menu-title">分类</span>
                </a>
            </li>
            <li class="menu-item menu-item-tags">
                <a href="/tags/">
                    <i class="icon icon-tags"></i>
                  <span class="menu-title">标签</span>
                </a>
            </li>
            <li class="menu-item menu-item-about">
                <a href="/about/">
                    <i class="icon icon-cup-fill"></i>
                  <span class="menu-title">关于</span>
                </a>
            </li>
        </ul>
      </nav>
    </div>
  </header>

<aside class="sidebar" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    
      <div class="widget">
    <h3 class="widget-title">公告</h3>
    <div class="widget-body">
        <div id="board">
            <div class="content"><p> No BUG No Life ! </p>
            </div>
        </div>
    </div>
</div>

      <div class="widget">
    <h3 class="widget-title"> 分类</h3>
    <div class="widget-body">
        <ul class="category-list">
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/charles/" class="category-list-link">charles</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/elasticsearch/" class="category-list-link">elasticsearch</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/idea/" class="category-list-link">idea</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/milvus/" class="category-list-link">milvus</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/netty/" class="category-list-link">netty</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/nginx/" class="category-list-link">nginx</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/rabbitmq/" class="category-list-link">rabbitmq</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/redis/" class="category-list-link">redis</a><span class="category-list-count">2</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/spring-authorization-server/" class="category-list-link">spring-authorization-server</a><span class="category-list-count">1</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/spring-boot/" class="category-list-link">spring-boot</a><span class="category-list-count">3</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/spring-cloud-alibaba/" class="category-list-link">spring-cloud-alibaba</a><span class="category-list-count">6</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/spring-security/" class="category-list-link">spring-security</a><span class="category-list-count">4</span></li>
            <li class="category-list-item"><a href="https://bluestaree.github.io/categories/%E7%AC%94%E8%AE%B0/" class="category-list-link">笔记</a><span class="category-list-count">57</span></li>
        </ul>
    </div>
</div>
      <div class="widget">
    <h3 class="widget-title"> 标签</h3>
    <div class="widget-body">
        <ul class="tag-list">
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/captcha/" class="tag-list-link">captcha</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/charles/" class="tag-list-link">charles</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/docker/" class="tag-list-link">docker</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/dubbo/" class="tag-list-link">dubbo</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/elasticsearch/" class="tag-list-link">elasticsearch</a><span
                    class="tag-list-count">7</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/equals/" class="tag-list-link">equals</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/gradle/" class="tag-list-link">gradle</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/hashcode/" class="tag-list-link">hashcode</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/hibernate/" class="tag-list-link">hibernate</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/idea/" class="tag-list-link">idea</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/jdk8/" class="tag-list-link">jdk8</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/json/" class="tag-list-link">json</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/jvm/" class="tag-list-link">jvm</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/maven/" class="tag-list-link">maven</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/milvus/" class="tag-list-link">milvus</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/mybatis/" class="tag-list-link">mybatis</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/nacos/" class="tag-list-link">nacos</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/netty/" class="tag-list-link">netty</a><span
                    class="tag-list-count">6</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/nginx/" class="tag-list-link">nginx</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/rabbitmq/" class="tag-list-link">rabbitmq</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/redis/" class="tag-list-link">redis</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/redisson/" class="tag-list-link">redisson</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/saas/" class="tag-list-link">saas</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/seata/" class="tag-list-link">seata</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/sentinel/" class="tag-list-link">sentinel</a><span
                    class="tag-list-count">2</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/spring-authorization-server/" class="tag-list-link">spring-authorization-server</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/spring-boot/" class="tag-list-link">spring-boot</a><span
                    class="tag-list-count">3</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/spring-cache/" class="tag-list-link">spring-cache</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/spring-security/" class="tag-list-link">spring-security</a><span
                    class="tag-list-count">4</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/" class="tag-list-link">正则表达式</a><span
                    class="tag-list-count">1</span></li>
            
            
            <li class="tag-list-item"><a href="https://bluestaree.github.io/tags/%E7%BC%93%E5%AD%98/" class="tag-list-link">缓存</a><span
                    class="tag-list-count">3</span></li>
            
        </ul>

    </div>
</div>
      
<div class="widget">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget-body">
        <ul class="recent-post-list list-unstyled no-thumbnail">
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://bluestaree.github.io/2024/03/spring-authorization-server%E6%8E%88%E6%9D%83%E7%A0%81%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B/" class="title">Spring Authorization Server授权码模式流程梳理</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2024-03-22 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-03-22</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://bluestaree.github.io/2024/01/sentinel%E7%BD%91%E5%85%B3%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E9%85%8D%E7%BD%AE/" class="title">sentinel网关流控规则配置</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2024-01-20 00:00:00 &#43;0000 UTC" itemprop="datePublished">2024-01-20</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://bluestaree.github.io/2023/12/elasticsearch-painless%E8%84%9A%E6%9C%AC%E6%95%99%E7%A8%8B/" class="title">Elasticsearch painless脚本教程</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2023-12-13 00:00:00 &#43;0000 UTC" itemprop="datePublished">2023-12-13</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://bluestaree.github.io/2023/11/nginx%E9%BB%91%E5%90%8D%E5%8D%95%E8%AE%BE%E7%BD%AE/" class="title">nginx黑名单设置</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2023-11-15 00:00:00 &#43;0000 UTC" itemprop="datePublished">2023-11-15</time>
                    </p>
                </div>
            </li>
            <li>
                <div class="item-inner">
                    <p class="item-title">
                        <a href="https://bluestaree.github.io/2023/09/mysql%E8%AE%A9%E6%8C%87%E5%AE%9A%E5%A4%9A%E4%B8%AAid%E4%BC%98%E5%85%88%E6%8E%92%E5%BA%8F/" class="title">mysql让指定多个id优先排序</a>
                    </p>
                    <p class="item-date">
                        <time datetime="2023-09-24 00:00:00 &#43;0000 UTC" itemprop="datePublished">2023-09-24</time>
                    </p>
                </div>
            </li>
        </ul>
    </div>
</div>
  </div>
</aside>

    
    
<aside class="sidebar sidebar-toc collapse" id="collapseToc" itemscope itemtype="http://schema.org/WPSideBar">
  <div class="slimContent">
    <h4 class="toc-title">文章目录</h4>
    <nav id="toc" class="js-toc toc">

    </nav>
  </div>
</aside>
<main class="main" role="main"><div class="content">
  <article id="-" class="article article-type-" itemscope
    itemtype="http://schema.org/BlogPosting">
    
    <div class="article-header">
      <h1 itemprop="name">
  <a
    class="article-title"
    href="/2022/09/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98/"
    >JVM内存调优</a
  >
</h1>

      <div class="article-meta">
        
<span class="article-date">
  <i class="icon icon-calendar-check"></i>&nbsp;
<a href="https://bluestaree.github.io/2022/09/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98/" class="article-date">
  <time datetime="2022-09-12 00:00:00 &#43;0000 UTC" itemprop="datePublished">2022-09-12</time>
</a>
</span>
<span class="article-category">
  <i class="icon icon-folder"></i>&nbsp;
  <a class="article-category-link" href="/categories/%E7%AC%94%E8%AE%B0/"> 笔记 </a>
</span>  
  <span class="article-tag">
    <i class="icon icon-tags"></i>&nbsp;
    <a class="article-tag-link" href="/tags/jvm/"> jvm </a>
  </span>

        <span class="post-comment"><i class="icon icon-comment"></i>&nbsp;<a href="/2022/09/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98/#comments"
            class="article-comment-link">评论</a></span>
		<span class="post-wordcount hidden-xs" itemprop="wordCount">字数统计: 10848字</span>
		<span class="post-readcount hidden-xs" itemprop="timeRequired">阅读时长: 22分 </span>
      </div>
    </div>
    <div class="article-entry marked-body js-toc-content" itemprop="articleBody">
      <hr>
<blockquote>
<p>最近发现服务器在部署一段时间后会自动重启，初步排查为内存原因，肯能存在内存泄漏，需进一步排查。这里记录一下相关学习记录</p>
</blockquote>
<h1 id="jvm内存调优">JVM内存调优</h1>
<h2 id="1jvm简介">1、JVM简介</h2>
<p>​		JVM是java虚拟机，是用来执行java字节码的虚拟计算机，它运行在操作系统之上与硬件没有任何关</p>
<p>系，简单来讲就是跨平台，一处编译到处运行。</p>
<p>​		Java程序的跨平台特性主要是指字节码文件可以在任何具有Java虚拟机的计算机或者电子设备上运</p>
<p>行，Java虚拟机中的Java解释器负责将字节码文件解释成为特定的机器码进行运行。因此在运行时，</p>
<p>Java源程序需要通过编译器编译成为.class文件。众所周知java.exe是java class文件的执行程序，但实际</p>
<p>上java.exe程序只是一个执行的外壳，它会装载jvm.dll（windows下，下皆以windows平台为例，linux</p>
<p>下和solaris下其实类似，为：libjvm.so），这个动态连接库才是java虚拟机的实际操作处理所在。</p>
<p>​		JVM是JRE的一部分。它是一个虚构出来的计算机，是通过在实际的计算机上仿真模拟各种计算机功</p>
<p>能来实现的。JVM有自己完善的硬件架构，如处理器、堆栈、寄存器等，还具有相应的指令系统。Java</p>
<p>语言最重要的特点就是跨平台运行。使用JVM就是为了支持与操作系统无关，实现跨平台。所以，JAVA</p>
<p>虚拟机JVM是属于JRE的，而现在我们安装JDK时也附带安装了JRE(当然也可以单独安装JRE)。</p>
<h2 id="2jvm内存">2、JVM内存</h2>
<p>​		粗略分来，JVM的内部体系结构分为三部分，分别是：类装载器（ClassLoader）子系统，运行时数</p>
<p>据区，和执行引擎。</p>
<h3 id="21类装载器">2.1、类装载器</h3>
<p>​		每一个Java虚拟机都由一个类加载器子系统（class loader subsystem），负责加载程序中的类型</p>
<p>（类和接口），并赋予唯一的名字。每一个Java虚拟机都有一个执行引擎（execution engine）负责执</p>
<p>行被加载类中包含的指令。JVM的两种类装载器包括：启动类装载器和用户自定义类装载器，启动类装</p>
<p>载器是JVM实现的一部分，用户自定义类装载器则是Java程序的一部分，必须是ClassLoader类的子类。</p>
<h3 id="22执行引擎">2.2、执行引擎</h3>
<p>​		它或者在执行字节码，或者执行本地方法。</p>
<p>​		主要的执行技术有:解释，即时编译，自适应优化、芯片级直接执行其中解释属于第一代JVM，即时</p>
<p>编译JIT属于第二代JVM，自适应优化（目前Sun的HotspotJVM采用这种技术）则吸取第一代JVM和第二</p>
<p>代JVM的经验，采用两者结合的方式 。</p>
<p>​		自适应优化：开始对所有的代码都采取解释执行的方式，并监视代码执行情况，然后对那些经常调</p>
<p>用的方法启动一个后台线程，将其编译为本地代码，并进行仔细优化。若方法不再频繁使用，则取消编</p>
<p>译过的代码，仍对其进行解释执行。</p>
<h3 id="23运行时数据区">2.3、运行时数据区</h3>
<p>​		主要包括：方法区，堆，Java栈，PC寄存器，本地方法栈。</p>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-1.png" alt="jvm内存调优-1"></p>
<h4 id="231程序计数器">2.3.1、程序计数器</h4>
<p>​		程序计数器（Program Counter Register)是一块较小的内存空间，它可以是看作当前线程所执行的</p>
<p>字节码的行号指示器。说简单一点就是一个计数器，当字节码解释器工作是能够通过改变这个计数器的</p>
<p>值来选取下一条需要执行的字节码指令。在说明一点，各条线程之间计数器互不影响，独立存储，程序</p>
<p>计数器器内存区域为线程私有的。</p>
<p>​		在JVM规范中规定，如果线程执行的是非native方法，则程序计数器中保存的是当前需要执行的指</p>
<p>令的地址；如果线程执行的是native方法，则程序计数器中的值是undefined。由于程序计数器中存储</p>
<p>的数据所占空间的大小不会随程序的执行而发生改变，因此，此内存区域是唯一一个在JVM规范中没有</p>
<p>规定任何OutOfMemoryError情况的区域。</p>
<h4 id="232本地方法栈">2.3.2、本地方法栈</h4>
<p>​		本地方法栈和虚拟机栈所发挥的作用是很相似的，它们之间的区别不过是 虚拟机栈为虚拟机执行</p>
<p>Java方法（字节码）服务，而本地方法栈则为虚拟机使用到的Native方法服务。Sun HotSpot 直接就把</p>
<p>本地方法栈和虚拟机栈合二为一。本地方法栈也会抛出StackOverflowError和OutOfMemoryError异</p>
<p>常。</p>
<h4 id="233java虚拟栈">2.3.3、Java虚拟栈</h4>
<p>​		Java栈也称作虚拟机栈（Java Vitual Machine Stack），也是常说的栈。Java栈是Java方法执行的内</p>
<p>存模型。Java栈中存放的是一个个的栈帧，每个栈帧对应一个被调用的方法，在栈帧中包括局部变量表</p>
<p>(Local Variables)、操作数栈(Operand Stack)、指向当前方法所属的类的运行时常量池（运行时常量池</p>
<p>的概念在方法区部分会谈到）的引用(Reference to runtime constant pool)、方法返回地址(Return</p>
<p>Address)和一些额外的附加信息。栈也是线程私有的。</p>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-2.png" alt="jvm内存调优-2"></p>
<ul>
<li>
<p>局部变量表</p>
<p>用来存储java方法中的局部变量的（包括在方法中声明的非静态变量以及函数形参）。对于基本数</p>
</li>
</ul>
<p>据类型的变量，则直接存储它的值，对于引用类型的变量，则存的是指向对象的引用。在编译期间就会</p>
<p>分配方法局部变量表的最大容量，局部变量表以变量槽为单位，每个变量槽可以存储32位及32位以下的</p>
<p>变量，具体大小根据变量实际占用内存而定，java的基本类型中除了long和double外其他类型都是32位</p>
<p>以下，所以每个变量占用一个变量槽即可，而对于long和double类的变量，会占用两个变量槽，除了基</p>
<p>本类型当然还有引用类型，引用类型变量长度JVM并没有明确定义。JVM通过索引的方式来访问变量表中</p>
<p>的变量，索引从0开始。变量槽是可以重复使用的，当变量槽所存储的变量已经不在其作用域后，该变量</p>
<p>槽就可以被其他变量占用。</p>
<ul>
<li>
<p>操作数栈</p>
<p>用于在方法运行时可以存放以及获取操作数，其所需要的最大栈深度也是在编译期间定下的，在方</p>
</li>
</ul>
<p>法刚开始运行时，操作数栈是空的，在方法执行过程中会有各种操作指令往操作数栈中压入和获取内</p>
<p>容，也就是出栈/入栈操作，比如一个加法指令对两个数据进行相加，运行到这里前会先将两个数据压入</p>
<p>栈中，然后将这两个操作数取出相加；在实际情况中，方法的操作数栈之间并不完全独立，往往会公用</p>
<p>部分空间，这样在方法调用时就不需要进行参数复制了。</p>
<ul>
<li>
<p>动态链接</p>
<p>前面说了常量池中会存储方法的符号引用，而每个栈帧中都会存储一个引用，用于指向常量池中该</p>
</li>
</ul>
<p>方法对应的符号引用，字节码指令中方法的调用就以方法对应的符号引用为参数来进行，在类加载阶段</p>
<p>的解析步骤中，部分符号引用会被解析为直接引用，称为静态解析，在方法的运行过程中，另一部分符</p>
<p>号引用会被实时的解析为直接引用，称为动态连接。</p>
<p>​		被静态解析的条件：方法在运行前就有一个可确定的调用版本，其实也就是编译期就刻意确定改方</p>
<p>法有没有可能通过继承或者其他方式被重写，在java中静态方法(与类型直接关联)，私有方法(外部不可</p>
<p>访问)，构造方法，父类方法，final方法，这五种方法的符号引用可以被静态解析都不可能被重写，可以</p>
<p>在运行前确定唯一的调用版本，满足被静态解析的条件，称为非虚方法。</p>
<ul>
<li>
<p>方法返回地址</p>
<p>方法的运行过程中，可能会正常退出，也可能会异常退出，不论是哪种退出方式，在退出后都会要</p>
</li>
</ul>
<p>保证其上层调用者可以知道方法退出的位置，以便于程序继续执行，方法的返回地址就是用于确定退出</p>
<p>位置的。</p>
<h4 id="234java堆">2.3.4、Java堆</h4>
<p>​		堆是jvm内存管理的最大的一块区域，此内存区域的唯一目的就是存放对象的实例，所有对象实例</p>
<p>与数组都要在堆上分配内存。它也是垃圾收集器的主要管理区域。java对可以处于物理上不连续的空</p>
<p>间，只要逻辑上是连续的即可。线程共享的区域。如果在堆中没有内存完成实例分配，并且堆也无法再</p>
<p>扩展时，将抛出OutOfMemoryError异常。</p>
<p>为了支持垃圾收集，堆被分为三个部分：</p>
<ul>
<li>年轻代：常常又被划分为Eden区和Survivor（From Survivor To Survivor）区(Eden空间、From</li>
<li>Survivor空间、To Survivor空间（空间分配比例是8：1：1）</li>
<li>老年代</li>
<li>永久代（jdk 8已移除永久代，被元数据代替）</li>
</ul>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-3.png" alt="jvm内存调优-3"></p>
<p>（1）堆是JVM中所有线程共享的，因此在其上进行对象内存的分配均需要进行加锁，这也导致了new对</p>
<p>象的开销是比较大的</p>
<p>（2）Sun Hotspot JVM为了提升对象内存分配的效率，对于所创建的线程都会分配一块独立的空间</p>
<p>TLAB（Thread Local Allocation Buffer），其大小由JVM根据运行的情况计算而得，在TLAB上分配对象</p>
<p>时不需要加锁，因此JVM在给线程的对象分配内存时会尽量的在TLAB上分配，在这种情况下JVM中分配</p>
<p>对象内存的性能和C基本是一样高效的，但如果对象过大的话则仍然是直接使用堆空间分配</p>
<p>（3）TLAB仅作用于新生代的Eden Space，因此在编写Java程序时，通常多个小的对象比大的对象分配</p>
<p>起来更加高效。</p>
<p>（4）所有新创建的Object 都将会存储在新生代Yong Generation中。如果Young Generation的数据在</p>
<p>一次或多次GC后存活下来，那么将被转移到OldGeneration。新的Object总是创建在Eden Space。</p>
<p>这些知识在后面学习GC和内存调优方面非常重要。</p>
<h4 id="235方法区">2.3.5、方法区</h4>
<p>​		方法区在JVM中也是一个非常重要的区域，它与堆一样，是被线程共享的区域。在方法区中，存储</p>
<p>了每个类的信息（包括类的名称、方法信息、字段信息）、静态变量、常量以及编译器编译后的代码</p>
<p>等。方法区是堆的一个逻辑部分，为了区分Java堆，它还有一个别名Non-Heap（非堆）。相对而言，</p>
<p>GC对于这个区域的收集是很少出现的。当方法区无法满足内存分配需求时，将抛出OutOfMemoryError</p>
<p>异常。</p>
<p>​		在Java 7及之前版本，我们也习惯称方法区它为“永久代”（Permanent Generation），更确切来</p>
<p>说，应该是“HotSpot使用永久代实现了方法区”！</p>
<h4 id="256运行时常量">2.5.6、运行时常量</h4>
<p>​		运行时常量池是方法区的一部分。Class文件中除了有类的版本、字段、方法、接口等描述信息外,</p>
<p>还有一项信息是常量池( Constant pool table)，用于<strong>存放编译期生成的各种字面量和符号引用</strong>，这部分</p>
<p>内容将在类加载后进入运行时常量池中存放。运行时常量池相对于class文件常量池的另外一个特性是<strong>具</strong></p>
<p><strong>备动态性</strong>，java语言并不要求常量一定只有编译器才产生，也就是并非预置入class文件中常量池的内容</p>
<p>才能进入方法区运行时常量池，运行期间也可能将新的常量放入池中。</p>
<h4 id="257直接内存">2.5.7、直接内存</h4>
<p>​		直接内存（Direct Memory）并不是虚拟机运行时数据区的一部分，也不是JVM规范中定义的内存</p>
<p>区域。但这部分内存也被频繁的使用，而且也可能导致OutOfMemoryError异常出现。JDK1.4中新引入</p>
<p>了NIO机制，它是一种基于通道与缓冲区的新I/O方式，可以直接从操作系统中分配直接内存，即<strong>直接堆</strong></p>
<p><strong>外分配内存</strong>，这样能在一些场景中提高性能，因为避免了在Java堆和Native堆中来回复制数据。</p>
<h3 id="24jdk7与jdk8内存模型对比">2.4、JDK7与JDK8内存模型对比</h3>
<h4 id="241方法区变化">2.4.1、方法区变化</h4>
<p>​		这里介绍的是JDK1.8 JVM内存模型。1.8同1.7比，最大的差别就是：<strong>元数据区取代了永久代</strong>，就是</p>
<p>JDK8没有了<strong>PermSize</strong>相关的参数配置了。元空间的本质和永久代类似，都是对JVM规范中方法区的实</p>
<p>现。不过元空间与永久代之间最大的区别在于：元数据空间并不在虚拟机中，而是使用本地内存。</p>
<p>1）方法区与永久代的区别？</p>
<ul>
<li>方法区只是JVM规范定义，而永久代为具体的实现，元空间也是方法区在jdk1.8中的一种实现。</li>
</ul>
<p>2）为什么废除永久代？</p>
<ul>
<li>官方文档：移除永久代是为融合HotSpot JVM与 JRockit VM而做出的努力，因为JRockit没有永久代，不需要配置永久代</li>
<li>PermGen很难调整，PermGen中类的元数据信息在每次FullGC的时候可能被收集，但成绩很难令人满意。</li>
<li>而且应该为PermGen分配多大的空间很难确定，因为PermSize的大小依赖于很多因素，比如JVM加载的class总数，常量池的大小，方法的大小等。</li>
<li>并且永久代内存经常不够用发生内存泄露。</li>
</ul>
<h4 id="242运行时常量池变化">2.4.2、运行时常量池变化</h4>
<p>​		在近三个JDK版本（1.6、1.7、1.8）中， 运行时常量池（Runtime Constant Pool）的所处区域一</p>
<p>直在不断的变化，在JDK1.6时它是方法区的一部分；1.7又把他放到了堆内存中；1.8之后出现了元空</p>
<p>间，它又回到了方法区。其实，这也说明了官方对“永久代”的优化从1.7就已经开始了</p>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-4.png" alt="jvm内存调优-4"></p>
<h3 id="25运行时异常">2.5、运行时异常</h3>
<table>
<thead>
<tr>
<th><strong>运行时区域</strong></th>
<th><strong>异常</strong></th>
<th><strong>主要原因</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>虚拟机栈和本地方法栈</td>
<td>StackOverflowError，OutOfMemoryError</td>
<td>StackOverflowError：线程请求的栈深度大于虚拟机所允许的最大深度；OutOfMemoryError：虚拟机在扩展栈时无法申请足够的内存空间</td>
</tr>
<tr>
<td>程序计数器</td>
<td>无</td>
<td>无</td>
</tr>
<tr>
<td>堆</td>
<td>OutOfMemoryError</td>
<td>对象数量到达最大堆的容量，内存泄漏、内存溢出</td>
</tr>
<tr>
<td>方法区和运行时常量池</td>
<td>OutOfMemoryError</td>
<td>反射，动态代理：CGLib、JSP、OSGI等</td>
</tr>
</tbody>
</table>
<ul>
<li>内存泄露（Memory Leak）：程序在申请内存后，对象没有被GC所回收，它始终占用内存，内存泄漏的堆积最终会造成内存溢出。</li>
<li>内存溢出（Memory Overflow）：程序运行过程中无法申请到足够的内存而导致的一种错误。内存溢出通常发生于OLD段或Perm段垃圾回收后，仍然无内存空间容纳新的Java对象的情况。通常都是由于内存泄露导致堆栈内存不断增大，从而引发内存溢出。</li>
</ul>
<h2 id="3jvm参数">3、JVM参数</h2>
<h3 id="31查看jvm参数">3.1、查看JVM参数</h3>
<pre><code>java -XX:+PrintFlagsFinal -version
</code></pre>
<h3 id="32日志设置">3.2、日志设置</h3>
<pre><code>-XX:+PrintFlagsFinal，打印JVM所有参数的值

-XX:+PrintGC，打印GC信息

-XX:+PrintGCDetails，打印GC详细信息

-XX:+PrintGCTimeStamps，打印GC的时间戳

-Xloggc:filename，设置GC log文件的位置

-XX:+PrintTenuringDistribution，查看熬过收集后剩余对象的年龄分布信息
</code></pre>
<h3 id="33内存设置">3.3、内存设置</h3>
<pre><code>-Xms，设置堆的初始化内存大小

-Xmx，设置堆的最大内存

-Xmn，设置新生代内存大小

-Xss，设置线程栈大小

-XX:NewRatio，新生代与老年代比值

-XX:SurvivorRatio，新生代中Eden区与两个Survivor区的比值，默认为8，即Eden:Survivor:Survivor=8:1:1

-XX:MaxTenuringThreshold，从年轻代到老年代，最大晋升年龄。CMS 下默认为 6，G1 下默认为 15

-XX:MetaspaceSize，设置元空间的大小，第一次超过将触发 GC

-XX:MaxMetaspaceSize，元空间最大值

-XX:MaxDirectMemorySize，用于设置直接内存的最大值，限制通过 DirectByteBuffer 申请的内存

-XX:ReservedCodeCacheSize，用于设置 JIT 编译后的代码存放区大小，如果观察到这个值有限制，可以适当调大，一般够用即可
</code></pre>
<h3 id="34垃圾收集设置">3.4、垃圾收集设置</h3>
<pre><code>-XX:+UseSerialGC，设置串行收集器

-XX:+UseParallelGC，设置并行收集器

-XX:+UseConcMarkSweepGC，使用CMS收集器

-XX:ParallelGCThreads，设置Parallel GC的线程数

-XX:MaxGCPauseMillis，GC最大暂停时间 ms

-XX:+UseG1GC，使用G1垃圾收集器

CMS 垃圾回收器相关

-XX:+UseCMSInitiatingOccupancyOnly

-XX:CMSInitiatingOccupancyFraction，与前者配合使用，指定MajorGC的发生时机

-XX:+ExplicitGCInvokesConcurrent，代码调用 System.gc() 开始并行 FullGC，建议加上这个参数

-XX:+CMSScavengeBeforeRemark，表示开启或关闭在 CMS 重新标记阶段之前的清除(YGC)尝试，它可以降低 remark 时间，建议加上

-XX:+ParallelRefProcEnabled，可以用来并行处理 Reference，以加快处理速度，缩短耗时

G1 垃圾回收器相关

-XX:MaxGCPauseMillis，用于设置目标停顿时间，G1 会尽力达成

-XX:G1HeapRegionSize，用于设置小堆区大小，建议保持默认

-XX:InitiatingHeapOccupancyPercent，表示当整个堆内存使用达到一定比例(默认是 45%)，并发标记阶段就会被启动

-XX:ConcGCThreads，表示并发垃圾收集器使用的线程数量，默认值随 JVM 运行的平台不同而变动，不建议修改。

参数查询官网地址：
https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html
</code></pre>
<h2 id="4jvm监视">4、JVM监视</h2>
<h3 id="41jps">4.1、jps</h3>
<p>​		显示当前运行的java进程以及相关参数。</p>
<pre><code>jps [options]
</code></pre>
<ul>
<li>-q：仅输出VM标识符，不包括classname,jar name,arguments in main method</li>
<li>-m：输出main method的参数</li>
<li>-l：输出完全的包名，应用主类名，jar的完全路径名</li>
<li>-v：输出jvm参数</li>
<li>-V：输出通过flag文件传递到JVM中的参数(.hotspotrc文件或-XX:Flags=所指定的文件</li>
</ul>
<h3 id="42jstat">4.2、jstat</h3>
<p>​		用于监控虚拟机各种运行状态信息的命令行工具。可以显示本地或远程虚拟机进程中的类装载、内</p>
<p>存、垃圾收集、JIT编译等运行数据。</p>
<pre><code>jstat [option vmid [interval[ s|ms] [count] ] ]

jstat -gc [pid]
</code></pre>
<p>​		vmid与lvmid需要特别说明下：如果是本地虚拟机进程，VMID和LVMID是一致的，如果是远程虚拟</p>
<p>机进程，那vmid的格式应当是：[protocol:][//] lvmid [@hostname[:port]/servername]。</p>
<p>​		interval代表查询间隔和次数，如果省略表示只查询一次。</p>
<ul>
<li>-class：监视类装载、卸载数量、总空间及类装载所耗费的时间</li>
<li>-gc：监视Java堆状况，包括Eden区、2个Survivor区、老年代、永久代等的容量</li>
<li>-gccapacity：监视内容与-gc基本相同，但输出主要关注Java堆各个区域使用到的最大和最小空间</li>
<li>-gcutil：监视内容与-gc基本相同，但输出主要关注已使用空间占总空间的百分比</li>
<li>-gccause：与-gcutil功能一样，但是会额外输出导致上一次GC产生的原因</li>
<li>-gcnew：监视新生代GC的状况</li>
<li>-gcnewcapacity：监视内容与-gcnew基本相同，输出主要关注使用到的最大和最小空间 -gcold 监视老年代GC的状况</li>
<li>-gcoldcapacity：监视内容与——gcold基本相同，输出主要关注使用到的最大和最小空间</li>
<li>-gcpermcapacity：输出永久代使用到的最大和最小空间 -compiler 输出JIT编译器编译过的方法、耗时等信息 -printcompilation 输出已经被JIT编译的方法</li>
</ul>
<h3 id="43jstatd">4.3、jstatd</h3>
<p>​		jstatd是一个基于RMI（Remove Method Invocation）的服务程序，它用于监控基于HotSpot的</p>
<p>JVM中资源的创建及销毁，并且提供了<strong>一个远程接口允许远程的监控工具连接到本地</strong>的JVM执行命令。</p>
<p>​		jstatd是基于RMI的，所以在运行jstatd的服务器上必须存在RMI注册中心，如果没有通过选项”-p</p>
<p>port”指定要连接的端口，jstatd会尝试连接RMI注册中心的默认端口。</p>
<ul>
<li>-nr 如果RMI注册中心没有找到，不会创建一个内部的RMI注册中心。</li>
<li>-p port RMI注册中心的端口号，默认为<strong>1099</strong>。</li>
<li>-n rminame 默认为<strong>JStatRemoteHost</strong>；如果同一台主机上同时运行了多个jstatd服务，rminame可以用于唯一确定一个jstatd服务；这里需要注意一下，如果开启了这个选项，那么监控客户端远程连接时，必须同时指定hostid及vmid，才可以唯一确定要连接的服务，这个可以参看jps章节中列出远程服务器上Java进程的示例。</li>
<li>-J 用于传递jvm选项到由javac调用的java加载器中，例如，“-J-Xms48m”将把启动内存设置为48M，使用-J选项可以非常方便的向基于Java的开发的底层虚拟机应用程序传递参数。</li>
</ul>
<h3 id="44jmc">4.4、jmc</h3>
<p>​		Java Mission Control，JMC打开性能日志后，主要包括7部分性能报告，分别是一般信息、内存、</p>
<p>代码、线程、I/O、系统、事件。其中，内存、代码、线程及I/O是系统分析的主要部分。</p>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-5.png" alt="jvm内存调优-5"></p>
<p><img src="https://raw.githubusercontent.com/bluestaree/bluestaree.github.io/master/image/jvm/jvm%E5%86%85%E5%AD%98%E8%B0%83%E4%BC%98-6.png" alt="jvm内存调优-6"></p>
<h2 id="5故障排除">5、故障排除</h2>
<h3 id="51jcmd">5.1、jcmd</h3>
<p>​		一个多功能的工具，可以用它来导出堆、查看Java进程、导出线程信息、执行GC、还可以进行采样</p>
<p>分析。</p>
<pre><code>1 jcmd &lt;pid | main class&gt; &lt;command ... | PerfCounter.print | -f file&gt;

2 jcmd -l

3 jcmd -h
</code></pre>
<ul>
<li>
<p><strong>pid</strong>：接收诊断命令请求的进程ID。</p>
<p>main class ：接收诊断命令请求的进程的main类。匹配进程时，main类名称中包含指定子字符串</p>
<p>的任何进程均是匹配的。如果多个正在运行的Java进程共享同一个main类，诊断命令请求将会发送</p>
<p>到所有的这些进程中。</p>
</li>
<li>
<p><strong>command</strong>：接收诊断命令请求的进程的main类。匹配进程时，main类名称中包含指定子字符串</p>
<p>的任何进程均是匹配的。如果多个正在运行的Java进程共享同一个main类，诊断命令请求将会发送</p>
<p>到所有的这些进程中。</p>
<p>注意: 如果任何参数含有空格，你必须使用英文的单引号或双引号将其包围起来。 此外，你必须使</p>
<p>用转义字符来转移参数中的单引号或双引号，以阻止操作系统shell处理这些引用标记。当然，你也</p>
<p>可以在参数两侧加上单引号，然后在参数内使用双引号(或者，在参数两侧加上双引号，在参数中使</p>
<p>用单引号)。</p>
</li>
<li>
<p><strong>Perfcounter.print</strong>：打印目标Java进程上可用的性能计数器。性能计数器的列表可能会随着Java</p>
<p>进程的不同而产生变化。</p>
</li>
<li>
<p><strong>-f file</strong>：从文件file中读取命令，然后在目标Java进程上调用这些命令。在file中，每个命令必须写在</p>
<p>单独的一行。以&rdquo;#&ldquo;开头的行会被忽略。当所有行的命令被调用完毕后，或者读取到含有stop关键</p>
<p>字的命令，将会终止对file的处理。</p>
</li>
<li>
<p><strong>-l</strong>：查看所有的进程列表信息。</p>
</li>
<li>
<p><strong>-h</strong>：查看帮助信息。（同 -help）</p>
</li>
</ul>
<h3 id="52jinfo">5.2、jinfo</h3>
<p>​		可以用来查看正在运行的 java 应用程序的扩展参数，包括Java System属性和JVM命令行参数；也</p>
<p>可以动态的修改正在运行的 JVM 一些参数。当系统崩溃时，jinfo可以从core文件里面知道崩溃的Java应</p>
<p>用程序的配置信息。</p>
<pre><code>jinfo -flag name pid
</code></pre>
<ul>
<li>
<p>pid 对应jvm的进程id</p>
</li>
<li>
<p>executable core 产生core dump文件</p>
</li>
<li>
<p>[server-id@]remote server IP or hostname 远程的ip或者hostname，server-id标记服务的唯一性id</p>
<p>option</p>
</li>
<li>
<p>no option 输出全部的参数和系统属性</p>
</li>
<li>
<p>-flag name 输出对应名称的参数</p>
</li>
<li>
<p>-flag [+|-]name 开启或者关闭对应名称的参数</p>
</li>
<li>
<p>-flag name=value 设定对应名称的参数</p>
</li>
<li>
<p>-flags 输出全部的参数</p>
</li>
<li>
<p>-sysprops 输出系统属性</p>
</li>
</ul>
<h3 id="53jmap">5.3、jmap</h3>
<p>​		用于打印指定Java进程(或核心文件、远程调试服务器)的共享对象内存映射或堆内存细节。</p>
<p>​		堆Dump是反应Java堆使用情况的内存镜像，其中主要包括系统信息、虚拟机属性、完整的线程</p>
<p>Dump、所有类和对象的状态等。 一般，在内存不足、GC异常等情况下，我们就会怀疑有内存泄露。这</p>
<p>个时候我们就可以制作堆Dump来查看具体情况。分析原因。</p>
<pre><code>jmap [option] vmid
</code></pre>
<ul>
<li>-dump：生成Java堆转储快照。格式为：-dump:[live,]format=b,file=，其中live子参数说明是否只dump出存活的对象</li>
<li>-finalizerinfo：显示在F-Queue中等待Finalizer线程执行finalize()方法的对象。只在Linux/Solaris平台下有效</li>
<li>-heap：显示Java堆详细信息，如使用哪种回收器、参数配置、分代状况等。只在Linux/Solaris平台下有效</li>
<li>-histo：显示堆中对象统计信息，包括类、实例数量和合计容量</li>
<li>-permstat：以ClassLoader为统计口径显示永久代内存状态。只在Linux/Solaris平台下有效</li>
<li>-F 当虚拟机进程对-dump选项没有响应时，可使用这个选项强制生成dump快照。只在Linux/Solaris平台下有效。</li>
</ul>
<h3 id="54jstack">5.4、jstack</h3>
<p>​		用于生成java虚拟机当前时刻的线程快照（一般称为threaddump或javacore文件）。线程快照就</p>
<p>是当前虚拟机内每一条线程正在执行的方法堆栈的集合，生成线程快照的主要目的就是定位线程出现长</p>
<p>时间停顿的原因，如线程间死锁、死循环、请求外部资源导致的长时间等待等都是导致线程长时间停顿</p>
<p>的常见原因。</p>
<pre><code>jstack [option] vmid
</code></pre>
<ul>
<li>- F : 当正常输出的请求不被响应时，强制输出线程堆栈；</li>
<li>-l ： 除堆栈外，显示关于锁的附加信息；</li>
<li>-m：如果调用到本地方法的话，可以显示C/C++的堆栈</li>
</ul>
<p>可以通过Thread类的getAllStackTraces()获取所有线程的StackTraceElement对象。</p>
<h2 id="6参数调优">6、参数调优</h2>
<h3 id="61直接内存">6.1、直接内存</h3>
<p>​		可以通过 <strong>-XX:MaxDirectMemorySize</strong> 参数来设置最大可用直接内存，如果启动时未设置则默认为</p>
<p>最大堆内存大小，即与 -Xmx 相同。即假如最大堆内存为1G，则默认直接内存也为1G，那么 JVM 最大</p>
<p>需要的内存大小为2G多一些。当直接内存达到最大限制时就会触发GC，如果回收失败则会引起</p>
<p>OutOfMemoryError。</p>
<h2 id="7内存问题定位">7、内存问题定位</h2>
<h3 id="71部署环境">7.1、部署环境</h3>
<p>​		采用docker-compose方式部署Java微服务程序。所以要排查内存泄露问题，就要进入docker容器进</p>
<p>行调试排查。</p>
<h3 id="72准备工作">7.2、准备工作</h3>
<ul>
<li>
<p>微服务docker部署采用的jdk版本为：adoptopenjdk/openjdk8。</p>
</li>
<li>
<p>微服务构建脚本docker-compose增加配置并重新构建服务：</p>
</li>
</ul>
<pre><code>cap_add:
- SYS_PTRACE
</code></pre>
<ul>
<li>安装gdb调试工具：</li>
</ul>
<pre><code>apt-get update
apt-get install gdb
</code></pre>
<ul>
<li>ptrace系统配置修改：</li>
</ul>
<pre><code>sudo vi /etc/sysctl.d/10-ptrace.conf
修改：kernel.yama.ptrace_scope = 0
执行:service procps restart
</code></pre>
<h3 id="73排查过程">7.3、排查过程</h3>
<ul>
<li>进入docker容器的挂载日志目录：</li>
</ul>
<pre><code>docker exec -it [容器id] /bin/bash
cd logs
</code></pre>
<ul>
<li>升序查看内存使用情况：</li>
</ul>
<pre><code>pmap -x [pid] | sort -n -k3

pid为应用程序的id,通过jps命令可以查看，一般docker容器下的java程序的pid都是：1。

对于iot-server-smart这个微服务：可以发现堆外内存有很多64mb左右的内存块，需要将这些内存
dump下来查看相关的代码信息：
00007fdb0c000000 61444 50540 50540 rw--- [ anon ]
00007fdaa0000000 61444 50800 50800 rw--- [ anon ]
00007fdb24000000 61444 51008 51008 rw--- [ anon ]
00007fdb2c000000 61444 51008 51008 rw--- [ anon ]
00007fdbe8000000 61500 51068 51068 rw--- [ anon ]
00007fdba0000000 61528 51092 51092 rw--- [ anon ]
00007fdbe4000000 61528 51336 51336 rw--- [ anon ]
00007fdbc0000000 61640 51668 51668 rw--- [ anon ]
00007fdbd4000000 63744 51856 51856 rw--- [ anon ]
00007fdbbc000000 61512 52016 52016 rw--- [ anon ]
00007fdbdc000000 61528 52044 52044 rw--- [ anon ]
00007fdbe0000000 61524 52056 52056 rw--- [ anon ]
00007fdb8c000000 61524 52060 52060 rw--- [ anon ]
00007fdbcc000000 63684 52068 52068 rw--- [ anon ]
00007fdbc4000000 61548 52136 52136 rw--- [ anon ]
00007fdb94000000 61536 52148 52148 rw--- [ anon ]
00007fdc04000000 61540 52152 52152 rw--- [ anon ]
00007fdb9c000000 61660 52172 52172 rw--- [ anon ]
00007fdbf4000000 61652 52200 52200 rw--- [ anon ]
00007fdbfc000000 61628 52220 52220 rw--- [ anon ]
00007fdbd8000000 61716 52272 52272 rw--- [ anon ]
00007fdc00000000 61824 52324 52324 rw--- [ anon ]
00007fdbd0000000 65008 52492 52492 rw--- [ anon ]
00007fdb84000000 62248 52564 52564 rw--- [ anon ]
00007fdb90000000 65136 54788 54788 rw--- [ anon ]
</code></pre>
<ul>
<li>dump指定内存块信息：</li>
</ul>
<pre><code>1、查看内存块的详细信息：
cat /proc/1/maps；

2、查看指定内存块：
cat /proc/1/maps | grep 7fdbd0000000 （7fdbd0000000，为上一步查看的结果）如下所
示：
7fdbd0000000-7fdbd3f7c000 rw-p 00000000 00:00 0

3、dump指定内存：
gdb --batch --pid 1 -ex &quot;dump memory iot-server-smart.dump 0x7fdbd0000000
0x7fdbd3f7c000&quot;
注意上面的命令开始和结束的内存地址要加上“0x”

4、生成的dump文件会在logs目录下，同时可以在宿主机微服务logs下用less命令查看。通过观察运
行的代码信息进一步排除内存泄露的原因

手动触发full gc 保存内存信息文件
5、jmap -dump:live,format=b,file=/ehaomiao/logs/heap-live.hprof 1

</code></pre>
<blockquote>
<p>附：MAT工具使用参考：<a href="https://www.jianshu.com/p/759e02c1feee">关于使用Eclipse Memory Analyzer的10点小技巧</a></p>
</blockquote>

    </div>
    <div class="article-footer">
    </div>
  </article>
<section id="comments">
</section>

</div><nav class="bar bar-footer clearfix" data-stick-bottom>
    <div class="bar-inner">
        <ul class="pager pull-left">
            <li class="prev">
                <a href="https://bluestaree.github.io/2022/08/pagehelper-%E7%9C%9F%E5%81%87%E5%88%86%E9%A1%B5/" title="pagehelper 实现假分页效果"><i
                        class="icon icon-angle-left"
                        aria-hidden="true"></i><span>&nbsp;&nbsp;下一篇</span></a>
            </li>
            <li class="next">
                <a href="https://bluestaree.github.io/2022/09/jvm%E5%86%85%E5%AD%98%E6%B3%84%E6%BC%8F%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5/"
                    title="JVM内存泄漏问题排查"><span>上一篇&nbsp;&nbsp;</span><i
                        class="icon icon-angle-right" aria-hidden="true"></i></a>
            </li>
            
            <li class="toggle-toc">
                <a class="toggle-btn collapsed" data-toggle="collapse" href="#collapseToc" aria-expanded="false"
                    title="文章目录" role="button">
                    <span>[&nbsp;</span><span>文章目录</span>
                    <i class="text-collapsed icon icon-anchor"></i>
                    <i class="text-in icon icon-close"></i>
                    <span>]</span>
                </a>
            </li>
        </ul>
        <div class="bar-right">
            <div class="share-component" data-sites="weibo,qq,wechat,facebook,twitter"
                data-mobile-sites="weibo,qq,qzone"></div>
        </div>
    </div>
</nav>

</main><footer class="footer" itemscope itemtype="http://schema.org/WPFooter">
<ul class="social-links">
    <li><a href="https://github.com/bluestaree" target="_blank" title="github" data-toggle=tooltip data-placement=top >
            <i class="icon icon-github"></i></a></li>
    <li><a href="https://bluestaree.github.io/index.xml" target="_blank" title="rss" data-toggle=tooltip data-placement=top >
            <i class="icon icon-rss"></i></a></li>
</ul>
  <div class="copyright">
    &copy;2019  -
    2024
    <div class="publishby">
        &bluestaree Powered by <a href="https://gohugo.io/" target="_blank"> hugo </a> <br>theme by <a href="https://themes.gohugo.io/" target="_blank"> pure</a>.
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.4.1/dist/jquery.min.js"></script>
<script>
    window.jQuery || document.write('<script src="js/jquery.min.js"><\/script>')
</script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/highlight.min.js"></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/python.min.js" defer></script>
<script type="text/javascript" src="https://cdn.staticfile.org/highlight.js/9.15.10/languages/javascript.min.js" defer></script><script>
    hljs.configure({
        tabReplace: '    ', 
        classPrefix: ''     
        
    })
    hljs.initHighlightingOnLoad();
</script>
<script src="https://bluestaree.github.io/js/application.min.bdeb64b910570b6c41badc6a05b7afb0c8ad9efd8525de3c7257d59e786326a3.js"></script>
<script src="https://bluestaree.github.io/js/plugin.min.51ff8c7317566f82259170fa36e09c4493adc9b9378b427a01ad3f017ebac7dd.js"></script>

<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(未命名)',
            },
            ROOT_URL: 'https:\/\/bluestaree.github.io\/',
            CONTENT_URL: 'https:\/\/bluestaree.github.io\/\/searchindex.json ',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script type="text/javascript" src="https://bluestaree.github.io/js/insight.min.a343cd9a5a7698336b28ef3a7c16a3a1b1d2d5fb17dc8ed04022bbe08cc5459073a15bdafa3a8a58cdd56080784bdd69fa70b1ae8597565c799c57ed00f0e120.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
<script>
    tocbot.init({
        
        tocSelector: '.js-toc',
        
        contentSelector: '.js-toc-content',
        
        headingSelector: 'h1, h2, h3',
        
        hasInnerContainers: true,
    });
</script>


  </body>
</html>
